<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengguna | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/cssadmin.css">

</head>

<body>

    <div class="sidebar">
        <div class="logo-area">
            <h3>Lab Admin</h3>
        </div>
        <nav>
            <a href="admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="peminjaman.html"><i class="fas fa-calendar-alt"></i> Peminjaman</a>
            <a href="konten.html"><i class="fas fa-newspaper"></i> Berita & Konten</a>
            <a href="pengguna.html" class="active"><i class="fas fa-users"></i> Pengguna</a>
            <a href="#" id="logoutTrigger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <header>
            <h1>Kelola Pengguna</h1>
        </header>

        <div class="data-section">

            <button class="btn-action create-new" id="tambahDosenBtn">
                <i class="fas fa-plus"></i> Tambah Dosen
            </button>

            <div id="messageArea" style="margin-top: 15px;"></div>

            <div id="dosenFormContainer" class="data-form-container">
                <h2>Tambah Dosen Baru</h2>
                <form id="dosenForm">
                    <input type="hidden" id="form-action" value="create">

                    <label for="input-user_id">User ID (Existing):</label>
                    <input type="number" id="input-user_id" name="user_id" required>
                    <small>Masukkan User ID yang sudah ada di tabel users (role harus 'dosen')</small>

                    <label for="input-nidn">NIDN:</label>
                    <input type="text" id="input-nidn" name="nidn" required>

                    <label for="input-nama">Nama Lengkap:</label>
                    <input type="text" id="input-nama" name="nama" required>

                    <label for="input-email">Email:</label>
                    <input type="email" id="input-email" name="email" required>

                    <label for="input-jabatan">Jabatan:</label>
                    <input type="text" id="input-jabatan" name="jabatan" required>

                    <label for="input-nip">NIP:</label>
                    <input type="text" id="input-nip" name="nip" required>

                    <label for="input-prodi">Prodi:</label>
                    <input type="text" id="input-prodi" name="prodi" required>

                    <label for="input-pendidikan">Pendidikan Terakhir:</label>
                    <input type="text" id="input-pendidikan" name="pendidikan" required>

                    <label for="input-matkul">Mata Kuliah Diampu:</label>
                    <input type="text" id="input-matkul" name="mata_kuliah" required>

                    <div class="form-actions">
                        <button type="submit" class="submit-button" id="formSubmitBtn">Simpan Dosen</button>
                        <button type="button" class="cancel-button" id="cancelFormBtn">Batal</button>
                    </div>
                </form>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <h2>Daftar Dosen</h2>
                    <thead>
                        <tr>
                            <th>NIDN</th>
                            <th>NIP</th>
                            <th>Nama</th>
                            <th>Email</th>
                            <th>Jabatan</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="dosenTableBody">
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <div id="logoutModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Konfirmasi Logout</h2>
            <p>Apakah Anda yakin ingin keluar dari sesi administrator?</p>
            <div class="modal-actions">
                <button id="cancelLogout" class="btn-modal-cancel">Batal</button>
                <button id="confirmLogout" class="btn-modal-confirm">Ya, Logout</button>
            </div>
        </div>
    </div>

    <script>
        const logoutTrigger = document.getElementById('logoutTrigger');
        const logoutModal = document.getElementById('logoutModal');
        const cancelLogoutBtn = document.getElementById('cancelLogout');
        const confirmLogoutBtn = document.getElementById('confirmLogout');

        logoutTrigger.addEventListener('click', (e) => {
            e.preventDefault();
            logoutModal.style.display = 'flex';
        });

        cancelLogoutBtn.addEventListener('click', () => {
            logoutModal.style.display = 'none';
        });

        confirmLogoutBtn.addEventListener('click', async () => {
            const url = '../backend/api/auth/logout.php';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                });
                const result = await response.json();

                if (result.success) {
                    logoutModal.style.display = 'none';
                    window.location.href = 'index.html';
                } else {
                    window.location.href = 'index.html';
                }

            } catch (error) {
                console.error('Logout Error:', error);
                window.location.href = 'index.html';
            }
        });

        window.addEventListener('click', (e) => {
            if (e.target === logoutModal) {
                logoutModal.style.display = 'none';
            }
        });

        // =======================================================
        // CRUD DOSEN
        // =======================================================
        const dosenTableBody = document.getElementById('dosenTableBody');
        const messageArea = document.getElementById('messageArea');
        const tambahDosenBtn = document.getElementById('tambahDosenBtn');
        const dosenFormContainer = document.getElementById('dosenFormContainer');
        const dosenForm = document.getElementById('dosenForm');
        const cancelFormBtn = document.getElementById('cancelFormBtn');
        const formSubmitBtn = document.getElementById('formSubmitBtn');
        const formTitle = dosenFormContainer.querySelector('h2');
        const formAction = document.getElementById('form-action');

        // Fungsi utilitas untuk pesan
        function displayMessage(type, message) {
            // Menggunakan kelas alert yang umum, pastikan Anda men-style ini di cssadmin.css
            messageArea.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        // Fungsi Reset Form ke mode Tambah (CREATE)
        function resetFormDosen() {
            dosenForm.reset();
            formTitle.textContent = 'Tambah Dosen Baru';
            formAction.value = 'create';
            document.getElementById('input-nidn').readOnly = false; // NIDN bisa diubah
            document.getElementById('input-user_id').readOnly = false;
            formSubmitBtn.textContent = 'Simpan Dosen';
            formSubmitBtn.classList.remove('update-button');
        }

        // --- TOGGLE FORM ---
        tambahDosenBtn.addEventListener('click', () => {
            if (dosenFormContainer.classList.contains('show')) {
                dosenFormContainer.classList.remove('show');
            } else {
                dosenFormContainer.classList.add('show');
                resetFormDosen();
            }
        });

        cancelFormBtn.addEventListener('click', () => {
            dosenFormContainer.classList.remove('show');
            resetFormDosen();
        });


        // --- FUNGSI GET (READ ALL) ---
        async function fetchDosen() {
            dosenTableBody.innerHTML = '<tr><td colspan="6">Memuat data...</td></tr>';
            const url = '../backend/api/dosen/list.php';

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Gagal mengambil data: ${response.statusText}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    dosenTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Error API: ${data.message || 'Data tidak dalam format array.'}</td></tr>`;
                    return;
                }

                dosenTableBody.innerHTML = ''; // Kosongkan sebelum mengisi

                if (data.length === 0) {
                    dosenTableBody.innerHTML = '<tr><td colspan="6">Tidak ada data Dosen yang ditemukan.</td></tr>';
                    return;
                }

                data.forEach(dosen => {
                    const row = dosenTableBody.insertRow();
                    row.innerHTML = `
                        <td>${dosen.nidn}</td>
                        <td>${dosen.nip || '-'}</td>
                        <td>${dosen.nama}</td>
                        <td>${dosen.email}</td>
                        <td>${dosen.jabatan || '-'}</td>
                        <td>
                            <button class="btn-action edit" onclick="editDosen('${dosen.nidn}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn-action delete" onclick="deleteDosen('${dosen.nidn}', '${dosen.nama}')"><i class="fas fa-trash"></i> Hapus</button>
                        </td>
                    `;
                });

            } catch (error) {
                console.error('Error fetching Dosen:', error);
                dosenTableBody.innerHTML = `<tr><td colspan="6" style="color: red;">Gagal memuat data Dosen. Pastikan Backend API berjalan atau Anda Login sebagai Admin.</td></tr>`;
            }
        }

        // --- FUNGSI CREATE & UPDATE (Handle Submit) ---
        dosenForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const action = formAction.value;
            const formData = new FormData(dosenForm);

            let url = '';

            if (action === 'create') {
                url = '../backend/api/dosen/create.php';
            } else if (action === 'update') {
                url = '../backend/api/dosen/update.php';
                // Tambahkan NIDN sebagai kunci UPDATE
                formData.append('nidn', document.getElementById('input-nidn').value);
            } else {
                return;
            }

            formSubmitBtn.disabled = true;
            formSubmitBtn.textContent = 'Memproses...';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    displayMessage('success', result.message || (action === 'create' ? 'Dosen berhasil ditambahkan!' : 'Data Dosen berhasil diubah!'));
                    dosenFormContainer.classList.remove('show');
                    resetFormDosen();
                    fetchDosen(); // Muat ulang data tabel
                } else {
                    displayMessage('error', result.message || (action === 'create' ? 'Gagal menambahkan Dosen.' : 'Gagal mengubah Dosen.'));
                }

            } catch (error) {
                console.error(`Error ${action} Dosen:`, error);
                displayMessage('error', 'Terjadi kesalahan jaringan/server.');
            } finally {
                formSubmitBtn.disabled = false;
                formSubmitBtn.textContent = (action === 'create' ? 'Simpan Dosen' : 'Ubah Dosen');
            }
        });

        // --- FUNGSI EDIT (READ SINGLE & Pre-fill Form) ---
        window.editDosen = async (nidn) => {
            const url = `../backend/api/dosen/detail.php?nidn=${nidn}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.nidn) {
                    // 1. Tampilkan Form dan Ubah Mode
                    dosenFormContainer.classList.add('show');
                    formTitle.textContent = 'Edit Data Dosen';
                    formAction.value = 'update';
                    formSubmitBtn.textContent = 'Ubah Dosen';

                    // 2. Isi Form dengan Data Dosen
                    document.getElementById('input-user_id').value = data.user_id;
                    document.getElementById('input-nidn').value = data.nidn;
                    document.getElementById('input-nama').value = data.nama;
                    document.getElementById('input-email').value = data.email;
                    document.getElementById('input-jabatan').value = data.jabatan;
                    document.getElementById('input-nip').value = data.nip;
                    document.getElementById('input-prodi').value = data.prodi;
                    document.getElementById('input-pendidikan').value = data.pendidikan;
                    document.getElementById('input-matkul').value = data.mata_kuliah;

                    // 3. Kunci field NIDN dan User ID (PK/FK)
                    document.getElementById('input-nidn').readOnly = true;
                    document.getElementById('input-user_id').readOnly = true;

                    // Scroll ke Form
                    dosenFormContainer.scrollIntoView({ behavior: 'smooth' });

                } else {
                    displayMessage('error', data.message || 'Gagal mengambil data detail Dosen.');
                }
            } catch (error) {
                console.error('Error fetching detail Dosen:', error);
                displayMessage('error', 'Terjadi kesalahan saat mengambil detail Dosen.');
            }
        };

        // --- FUNGSI DELETE ---
        window.deleteDosen = async (nidn, nama) => {
            if (!confirm(`Apakah Anda yakin ingin menghapus Dosen: ${nama} (${nidn})? Tindakan ini tidak dapat dibatalkan.`)) {
                return;
            }

            const url = '../backend/api/dosen/delete.php';
            const formData = new FormData();
            formData.append('nidn', nidn);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    displayMessage('success', result.message || `Dosen ${nama} berhasil dihapus.`);
                    fetchDosen(); // Muat ulang data tabel
                } else {
                    displayMessage('error', result.message || `Gagal menghapus Dosen ${nama}.`);
                }

            } catch (error) {
                console.error('Error deleting Dosen:', error);
                displayMessage('error', 'Terjadi kesalahan jaringan/server saat menghapus.');
            }
        };


        // Panggil fungsi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', fetchDosen);
    </script>
</body>

</html>