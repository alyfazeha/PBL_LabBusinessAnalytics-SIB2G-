<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Dosen | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/cssadmin.css">
    <style>
        .input-group-file, .input-group-url {
            margin-bottom: 10px;
            padding: 5px 0;
            border-left: 3px solid #007bff;
            padding-left: 10px;
        }
        .input-group-url { border-left: 3px solid #ffc107; }
        .input-group-file input[type="file"], .input-group-url input[type="text"] { width: 100%; }
        .foto-preview-container { text-align: center; margin-bottom: 15px; }
        .foto-preview {
            width: 100px; height: 100px; object-fit: cover;
            border-radius: 50%; border: 3px solid #ddd;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="logo-area">
            <h3>Lab Admin</h3>
        </div>
        <nav>
            <a href="admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="peminjaman.html"><i class="fas fa-calendar-alt"></i> Peminjaman</a>
            <a href="konten.html"><i class="fas fa-newspaper"></i> Berita & Konten</a>
            <a href="dosen.html" class="active"><i class="fas fa-users"></i> Data Dosen</a>
            <a href="#" id="logoutTrigger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content-dosen">
        <header>
            <div class="page-title-group">
                <a href="dosen.html" class="back-icon-link" title="Kembali ke Daftar Dosen">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1>Edit Data Dosen</h1>
                <span id="dosen-nidn-display" style="margin-left:10px; font-weight:bold; color:#555;"></span>
            </div>
        </header>
        <div class="data-section">
            <div id="message" class="message" style="margin-bottom: 20px; display: none;"></div>

            <div class="data-form-container">
                <h2>Form Edit Data Dosen</h2>

                <form id="editDosenForm" class="data-form form-grid" enctype="multipart/form-data">
                    <input type="hidden" id="input-nidn-key" name="nidn"> <div class="form-column">
                        <div class="form-group">
                            <label for="input-user_id">User ID (Akun Login):</label>
                            <input type="text" id="input-user_id" name="user_id" readonly 
                                   style="background-color: #eee; cursor: not-allowed;" title="User ID tidak bisa diubah">
                        </div>
                        <div class="form-group">
                            <label for="input-nidn">NIDN:</label>
                            <input type="text" id="input-nidn" name="nidn_display" readonly
                                   style="background-color: #eee; cursor: not-allowed;" title="NIDN tidak bisa diubah (Primary Key)">
                        </div>
                        <div class="form-group">
                            <label for="input-nip">NIP:</label>
                            <input type="text" id="input-nip" name="nip">
                        </div>
                        <div class="form-group">
                            <label for="input-nama">Nama Lengkap:</label>
                            <input type="text" id="input-nama" name="nama" required>
                        </div>
                        <div class="form-group">
                            <label for="input-email">Email:</label>
                            <input type="email" id="input-email" name="email" required>
                        </div>
                    </div>

                    <div class="form-column">
                        <div class="form-group">
                            <label for="input-jabatan">Jabatan:</label>
                            <input type="text" id="input-jabatan" name="jabatan" required>
                        </div>
                        <div class="form-group">
                            <label for="input-prodi">Prodi:</label>
                            <input type="text" id="input-prodi" name="prodi" required>
                        </div>
                        <div class="form-group">
                            <label for="input-pendidikan">Pendidikan Terakhir:</label>
                            <input type="text" id="input-pendidikan" name="pendidikan">
                        </div>

                        <div class="form-group">
                            <label>Foto Profil:</label>
                            
                            <div class="foto-preview-container">
                                <img id="current-foto" src="" alt="Foto Lama" class="foto-preview" style="display:none;">
                                <p id="no-foto-text" style="color: #777; font-style: italic;">Tidak ada foto saat ini.</p>
                            </div>

                            <label style="font-weight: normal;">Ganti Foto (Opsional):</label>
                            
                            <div class="input-group-file">
                                <label for="input-file-foto">Upload File Baru:</label>
                                <input type="file" id="input-file-foto" name="foto_file" accept="image/*">
                            </div>

                            <div class="input-group-url">
                                <label for="input-link-foto">Atau Link URL Baru:</label>
                                <input type="text" id="input-link-foto" name="foto_path" placeholder="https://website.com/baru.jpg">
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="input-matkul">Mata Kuliah Diampu:</label>
                            <textarea id="input-matkul" name="mata_kuliah" rows="3"></textarea>
                        </div>
                    </div>

                    <div class="form-actions full-width">
                        <button type="submit" class="submit-button update-button"><i class="fas fa-sync-alt"></i> Update Dosen</button>
                        <a href="dosen.html" class="cancel-button"><i class="fas fa-times"></i> Batal</a>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <script>
        // --- LOGIKA PESAN ---
        const messageDiv = document.getElementById('message');
        function displayMessage(type, text) {
            messageDiv.textContent = text;
            messageDiv.className = `alert alert-${type}`;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }

        function getNidnFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('nidn');
        }

        // --- FUNGSI MUAT DATA LAMA (DETAIL) ---
        async function fetchDosenDetail(nidn) {
            const url = `../backend/api/dosen/detail.php?nidn=${nidn}`;
            
            try {
                const response = await fetch(url);
                
                // Cek jika error 500/404
                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }

                const data = await response.json();

                if (data && data.nidn) {
                    // Isi Form dengan data lama
                    document.getElementById('input-nidn-key').value = data.nidn;
                    document.getElementById('input-nidn').value = data.nidn;
                    document.getElementById('input-user_id').value = data.user_id;
                    document.getElementById('input-nip').value = data.nip || '';
                    document.getElementById('input-nama').value = data.nama || '';
                    document.getElementById('input-email').value = data.email || '';
                    document.getElementById('input-jabatan').value = data.jabatan || '';
                    document.getElementById('input-prodi').value = data.prodi || '';
                    document.getElementById('input-pendidikan').value = data.pendidikan || '';
                    document.getElementById('input-matkul').value = data.mata_kuliah || '';

                    // Judul
                    document.getElementById('dosen-nidn-display').textContent = `(${data.nidn})`;

                    // --- PREVIEW FOTO PINTAR ---
                    const fotoPath = data.foto_path;
                    const imgPreview = document.getElementById('current-foto');
                    const noFoto = document.getElementById('no-foto-text');

                    if (fotoPath && fotoPath.trim() !== "") {
                        imgPreview.style.display = 'block';
                        noFoto.style.display = 'none';

                        if (fotoPath.startsWith('http')) {
                            // Jika link online, pakai langsung
                            imgPreview.src = fotoPath;
                        } else {
                            // Jika file lokal (upload), tambahkan path relatif ke frontend
                            imgPreview.src = `../frontend/${fotoPath}`;
                        }
                    } else {
                        imgPreview.style.display = 'none';
                        noFoto.style.display = 'block';
                    }

                } else {
                    displayMessage('error', 'Data Dosen tidak ditemukan.');
                }
            } catch (error) {
                console.error('Error fetching detail:', error);
                displayMessage('error', 'Gagal memuat data lama. Cek koneksi atau detail.php.');
            }
        }

        // --- FUNGSI UPDATE DATA ---
        const form = document.getElementById('editDosenForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Backend update.php (pastikan file ini juga sudah pakai path ../../ yang benar)
            const url = '../backend/api/dosen/update.php';
            const formData = new FormData(form);

            const btn = form.querySelector('.submit-button');
            btn.disabled = true;
            btn.innerHTML = 'Memproses...';

            try {
                const response = await fetch(url, { method: 'POST', body: formData });
                const result = await response.json();

                if (result.success) {
                    displayMessage('success', 'Data Dosen berhasil diupdate!');
                    setTimeout(() => { window.location.href = 'dosen.html'; }, 1500);
                } else {
                    displayMessage('error', result.message || 'Gagal update.');
                }
            } catch (error) {
                console.error('Update error:', error);
                displayMessage('error', 'Terjadi kesalahan jaringan.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Dosen';
            }
        });

        // Jalankan saat load
        document.addEventListener('DOMContentLoaded', () => {
            const nidn = getNidnFromUrl();
            if (nidn) fetchDosenDetail(nidn);
            else displayMessage('error', 'URL tidak valid (NIDN hilang).');
        });
    </script>
</body>
</html>