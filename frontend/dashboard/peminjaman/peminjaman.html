<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peminjaman | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/cssadmin.css">
</head>

<body>
    <div class="sidebar">
        <div class="logo-area">
            <h3>Lab Admin</h3>
        </div>
        <nav>
            <a href="../admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="peminjaman.html" class="active"><i class="fas fa-calendar-alt"></i> Peminjaman</a>
            <a href="../konten/konten.html"><i class="fas fa-newspaper"></i> Berita & Konten</a>
            <a href="../publikasi/publikasi.html"><i class="fas fa-book"></i> Publikasi</a>
            <a href="../dosen/dosen.html"><i class="fas fa-users"></i> Data Dosen</a>
            <a href="../mahasiswa/mahasiswa.html"><i class="fas fa-user-graduate"></i> Data Mahasiswa</a>
            <a href="#" id="logoutTrigger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <header>
            <div class="header-title">
                <h2>Kelola Peminjaman</h2>
            </div>
            <a href="tambah_peminjaman.html" class="btn btn-add"><i class="fas fa-plus"></i> Tambah Peminjaman</a>
        </header>

        <main>
            <div id="statusMessage" class="status-message" style="display:none; padding: 10px; margin-bottom: 20px;">
            </div>



            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama Mahasiswa</th>
                            <th>Nama Dosen PJ</th>
                            <th>Sarana</th>
                            <th>Tanggal</th>
                            <th>Waktu</th>
                            <th>Keperluan Meminjam</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="peminjamanTableBody">
                        <tr>
                            <td colspan="9">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="rejectModal" class="modal reject-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeRejectModal()">&times;</span>
            <h4>Tolak Peminjaman</h4>
            <p>Anda akan menolak peminjaman dengan ID: <span id="rejectIdDisplay"></span>. Masukkan alasan penolakan:
            </p>
            <textarea id="rejectionReason" rows="4"
                placeholder="Alasan penolakan wajib diisi (minimal 5 karakter)"></textarea>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeRejectModal()">Batal</button>
                <button class="btn btn-danger" onclick="rejectPeminjaman()">Tolak Permanen</button>
            </div>

        </div>
    </div>

    <div id="approveModal" class="modal approve-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeApproveModal()">&times;</span>
            <h4>Setujui Peminjaman</h4>
            <p>Anda yakin ingin menyetujui peminjaman dengan ID: <span id="approveIdDisplay"></span>?</p>

            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeApproveModal()">Batal</button>
                <button class="btn btn-action" onclick="approvePeminjaman()">Ya, Setujui</button>
            </div>
        </div>
    </div>

    <div id="logoutModal" class="modal logout-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="logoutModal.style.display='none';">&times;</span>

            <h4><i class="fas fa-sign-out-alt"></i> Konfirmasi Logout</h4>

            <p>Anda yakin ingin mengakhiri sesi dan keluar dari Panel Admin?</p>

            <div class="modal-buttons">
                <button id="cancelLogoutBtn" class="btn btn-secondary">Batal</button>
                <button id="confirmLogoutBtn" class="btn btn-danger">Ya, Logout</button>
            </div>

        </div>
    </div>

    <script>
        const BASE_API_URL = '../../../backend/api/booking/';

        // --- FUNGSI UTILITY ---
        function showStatusMessage(message, type = 'error') {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            // Gunakan class atau style untuk warna
            statusDiv.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';
            statusDiv.style.color = 'white';
            statusDiv.style.padding = '10px';
            statusDiv.style.marginBottom = '20px';
            statusDiv.style.borderRadius = '5px';
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // --- FUNGSI FETCH DATA PEMINJAMAN ---
        async function fetchPeminjaman() {
            const tableBody = document.getElementById('peminjamanTableBody');
            // Colspan 9
            tableBody.innerHTML = '<tr><td colspan="9" class="loading-state">Memuat data...</td></tr>';

            try {
                const response = await fetch(BASE_API_URL + 'list.php');
                const result = await response.json();

                // 1. Cek respon status HTTP dan error dari API
                if (!response.ok || result.error) {
                    const errorMessage = result.error || result.message || `Gagal memuat data. Status: ${response.status}.`;
                    showStatusMessage(errorMessage);
                    tableBody.innerHTML = '<tr><td colspan="9" style="color: red;">Error: Data gagal dimuat. Cek Console.</td></tr>';
                    return;
                }

                // 2. Koreksi pengambilan data dari respons (harus array di key 'data')
                if (result.status === 'success' && Array.isArray(result.data)) {
                    const data = result.data; // Ambil array data dari key 'data'

                    tableBody.innerHTML = '';

                    if (data.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="9" class="loading-state">Tidak ada data peminjaman.</td></tr>';
                        return;
                    }

                    data.forEach(item => {
                        const row = tableBody.insertRow();

                        // Default nama jika data dari backend null/kosong
                        const namaMahasiswa = item.nama_mahasiswa ? item.nama_mahasiswa : '-';
                        const namaDosen = item.nama_dosen ? item.nama_dosen : '-';

                        row.insertCell().textContent = item.booking_id; // 1. ID
                        // item.peminjam (username) DILOMPATI / DIHAPUS
                        row.insertCell().textContent = namaMahasiswa; // 2. Nama Mahasiswa
                        row.insertCell().textContent = namaDosen; // 3. Nama Dosen PJ
                        row.insertCell().textContent = item.nama_sarana; // 4. Sarana
                        row.insertCell().textContent = item.tanggal; // 5. Tanggal
                        row.insertCell().textContent = `${item.start_time.substring(0, 5)} - ${item.end_time.substring(0, 5)}`; // 6. Waktu
                        row.insertCell().textContent = item.keperluan; // 7. KEPERLUAN BARU


                        const statusCell = row.insertCell(); // 8. Status
                        // Pastikan status adalah uppercase untuk mencocokkan class CSS
                        const statusText = item.status.toUpperCase();
                        statusCell.innerHTML = `<span class="status ${statusText}">${statusText}</span>`;

                        const actionCell = row.insertCell(); // 9. Aksi

                        // GANTI BLOK INI di fungsi fetchPeminjaman()
                        // LOGIKA TOMBOL AKSI
                        const statusLower = item.status.toLowerCase();
                        const isPending = statusLower === 'pending' || statusLower === 'diajukan'; // Tambahkan 'diajukan'

                        // Tombol Aksi (Struktur Vertikal Khusus)
                        actionCell.innerHTML = `
                            <div class="action-buttons-list action-buttons-vertical">
                                <a href="detail_peminjaman.html?id=${item.booking_id}" class="btn btn-detail action-full-width"><i class="fas fa-eye"></i> Detail</a>
                                ${isPending ? `
                                <div class="action-buttons-list action-buttons-split">
                                    <button class="btn btn-action" onclick="showApproveModal(${item.booking_id})"><i class="fas fa-check"></i> Setuju</button>
                                    <button class="btn btn-danger" onclick="showRejectModal(${item.booking_id})"><i class="fas fa-times"></i> Tolak</button>
                                </div>
                                ` : ''}
                            </div>
                        `;
                    });
                } else {
                    showStatusMessage(result.message || 'Format data dari server tidak valid.');
                    tableBody.innerHTML = '<tr><td colspan="9" style="color: red;">Error: Data gagal diurai. Cek format backend.</td></tr>';
                }

            } catch (error) {
                console.error('Fetch Error:', error);
                showStatusMessage(`Terjadi kesalahan jaringan: ${error.message}`);
                tableBody.innerHTML = '<tr><td colspan="9" style="color: red;">Error Jaringan: Gagal terhubung ke API.</td></tr>';
            }
        }

        // --- FUNGSI AKSI (APPROVE/REJECT) ---
        let currentBookingId = null;

        function showApproveModal(id) {
            currentBookingId = id;
            document.getElementById('approveIdDisplay').textContent = id;
            document.getElementById('approveModal').style.display = 'flex';
        }

        function closeApproveModal() {
            document.getElementById('approveModal').style.display = 'none';
        }

        function showRejectModal(id) {
            currentBookingId = id;
            document.getElementById('rejectIdDisplay').textContent = id;
            document.getElementById('rejectionReason').value = ''; // Reset alasan
            document.getElementById('rejectModal').style.display = 'flex';
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').style.display = 'none';
        }

        async function approvePeminjaman() {
            if (!currentBookingId) return;

            const formData = new FormData();
            formData.append('booking_id', currentBookingId);

            closeApproveModal(); // Tutup modal saat proses dimulai

            try {
                const response = await fetch(BASE_API_URL + 'approve.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showStatusMessage('Peminjaman berhasil disetujui.', 'success');
                    fetchPeminjaman(); // Muat ulang data
                } else {
                    showStatusMessage(`Gagal menyetujui: ${result.message}`);
                }

            } catch (error) {
                console.error('Approve Error:', error);
                showStatusMessage('Error jaringan saat menyetujui peminjaman.');
            }
        }

        async function rejectPeminjaman() {
            if (!currentBookingId) return;

            const reason = document.getElementById('rejectionReason').value.trim();
            if (reason.length < 5) {
                alert("Alasan penolakan harus diisi minimal 5 karakter.");
                return;
            }

            const formData = new FormData();
            formData.append('booking_id', currentBookingId);
            formData.append('reason', reason);

            closeRejectModal(); // Tutup modal saat proses dimulai

            try {
                const response = await fetch(BASE_API_URL + 'reject.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showStatusMessage('Peminjaman berhasil ditolak.', 'success');
                    fetchPeminjaman(); // Muat ulang data
                } else {
                    showStatusMessage(`Gagal menolak: ${result.message}`);
                }

            } catch (error) {
                console.error('Reject Error:', error);
                showStatusMessage('Error jaringan saat menolak peminjaman.');
            }
        }

        // --- LOGIKA UTAMA & LOGOUT ---
        document.addEventListener('DOMContentLoaded', fetchPeminjaman);

        // Logika Logout
        const logoutModal = document.getElementById('logoutModal');
        const logoutTrigger = document.getElementById('logoutTrigger');
        const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
        const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');

        logoutTrigger.addEventListener('click', (e) => {
            e.preventDefault();
            logoutModal.style.display = 'flex';
        });

        cancelLogoutBtn.addEventListener('click', () => {
            logoutModal.style.display = 'none';
        });

        confirmLogoutBtn.addEventListener('click', async () => {
            const url = '../../../backend/api/auth/logout.php';

            try {
                await fetch(url, {
                    method: 'POST',
                });
                window.location.href = '../../public/index.html';

            } catch (error) {
                console.error('Logout Error:', error);
                window.location.href = '../../public/index.html';
            }
        });

        // Tutup modal jika klik di luar area modal
        window.addEventListener('click', (e) => {
            if (e.target === logoutModal) {
                logoutModal.style.display = 'none';
            }
            if (e.target === rejectModal) {
                rejectModal.style.display = 'none';
            }
            if (e.target === approveModal) {
                approveModal.style.display = 'none';
            }
        });
    </script>
</body>

</html>