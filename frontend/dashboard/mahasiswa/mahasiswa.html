<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Mahasiswa | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/cssadmin.css">
    <link rel="stylesheet" href="../../assets/css/cssmahasiswa.css">

    <style>
        /* Sinkronisasi Lebar Kolom */
        .data-table th:nth-child(1) {
            width: 50px;
            text-align: center;
        }

        .data-table th:nth-child(2) {
            width: 220px;
        }

        .data-table th:nth-child(3) {
            width: 220px;
        }

        .data-table th:nth-child(4) {
            width: 120px;
            text-align: center;
        }

        .data-table th:nth-child(5) {
            width: 150px;
        }

        .data-table th:nth-child(6) {
            width: 140px;
        }

        .data-table th:nth-child(7) {
            width: 110px;
            text-align: center;
        }

        .sub-info {
            display: block;
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 2px;
            font-weight: 400;
        }

        .email-link {
            text-decoration: none;
            color: #0d6efd;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }

        .password-box {
            font-family: monospace;
            color: #e67e22;
            background: #fdf5e6;
            padding: 1px 4px;
            border-radius: 3px;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .edit-btn,
        .delete-btn {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px 0;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            max-width: 45px;
            color: white;
        }

        .edit-btn {
            background-color: #f39c12;
        }

        .edit-btn:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
        }

        .delete-btn {
            background-color: #e74c3c;
        }

        .delete-btn:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .category-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 600;
            background: #e1f5fe;
            color: #039be5;
        }



        .search-filter-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .search-container {
            flex: 1;
            max-width: 350px;
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            border-radius: 10px;
            padding: 0 15px;
        }

        .search-container input {
            border: none;
            outline: none;
            padding: 10px 0;
            width: 100%;
            background: transparent;
            font-size: 13px;
        }

        .filter-select-modern {
            padding: 10px;
            border-radius: 10px;
            border: 1.5px solid #e2e8f0;
            background: #f8fafc;
            font-size: 13px;
            outline: none;
            cursor: pointer;
        }

        .telp-link {
            color: #28a745;
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex !important;
        }
    </style>
</head>

<body>
    <div id="toastNotificationContainer"></div>

    <div class="sidebar">
        <div class="logo-area">
            <h3>Lab Admin</h3>
        </div>
        <nav>
            <a href="../admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="../../public/index.html"
                style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; padding-top: 15px;">
                <i class="fas fa-external-link-alt"></i> Lihat Landing Page
            </a>
            <a href="../peminjaman/peminjaman.html"><i class="fas fa-calendar-alt"></i> Peminjaman</a>
            <a href="../konten/konten.html"><i class="fas fa-newspaper"></i> Berita & Konten</a>
            <a href="../publikasi/publikasi.html"><i class="fas fa-book"></i> Publikasi</a>
            <a href="../dosen/dosen.html"><i class="fas fa-users"></i> Data Dosen</a>
            <a href="mahasiswa.html" class="active"><i class="fas fa-user-graduate"></i> Data Mahasiswa</a>
            <a href="#" id="logoutTrigger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <header>
            <div class="header-title">
                <h2>Kelola Data Mahasiswa</h2>
            </div>
            <div class="header-actions-group">
                <div class="search-filter-wrapper">
                    <div class="search-container">
                        <i class="fas fa-search" style="color: #a0aec0; margin-right: 10px;"></i>
                        <input type="text" id="searchInput" placeholder="Cari Nama atau NIM..." onkeyup="filterTable()">
                    </div>
                    <select id="filterTingkat" class="filter-select-modern" onchange="filterTable()">
                        <option value="">Semua Tingkat</option>
                        <option value="1">Tingkat 1</option>
                        <option value="2">Tingkat 2</option>
                        <option value="3">Tingkat 3</option>
                        <option value="4">Tingkat 4</option>
                    </select>
                </div>
                <a href="tambah_mahasiswa.html" class="btn btn-primary btn-add">
                    <i class="fas fa-plus"></i> Tambah Mahasiswa
                </a>
            </div>
        </header>

        <main>
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="text-align: center;">No.</th>
                            <th>Mahasiswa</th>
                            <th>Kontak & Akun</th>
                            <th style="text-align: center;">Tingkat</th>
                            <th>Prodi</th>
                            <th>No. Telp</th>
                            <th style="text-align: center;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="mahasiswaTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="deleteModal" class="modal">
        <div class="modal-content" style="text-align: left !important;">
            <h4><i class="fas fa-trash-alt" style="color: #dc3545;"></i> Konfirmasi Hapus</h4>
            <p>Hapus mahasiswa: <strong id="namaHapus"></strong>?</p>
            <div class="modal-buttons">
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Batal</button>
                <button id="confirmDeleteBtn" class="btn btn-danger">Ya, Hapus</button>
            </div>
        </div>
    </div>

    <div id="logoutModal" class="modal logout-modal">
        <div class="modal-content" style="text-align: left !important;">
            <span class="close-btn" onclick="logoutModal.style.display='none';">&times;</span>
            <h4><i class="fas fa-sign-out-alt"></i> Konfirmasi Logout</h4>
            <p>Anda yakin ingin mengakhiri sesi dan keluar dari Panel Admin?</p>
            <div class="modal-buttons">
                <button id="cancelLogoutBtn" class="btn btn-secondary">Batal</button>
                <button id="confirmLogoutBtn" class="btn btn-danger">Ya, Logout</button>
            </div>
        </div>
    </div>


    <script>
        let allMahasiswaData = [];
        let nimToDelete = null;

        async function fetchMahasiswa() {
            const tbody = document.getElementById('mahasiswaTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px;">Memuat data...</td></tr>';
            try {
                const res = await fetch(`../../../backend/api/mahasiswa/list.php?t=${new Date().getTime()}`);
                allMahasiswaData = await res.json();
                renderTable(allMahasiswaData);
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Gagal memuat data.</td></tr>';
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('mahasiswaTableBody');
            tbody.innerHTML = '';
            data.forEach((m, index) => {
                const passText = m.initial_password
                    ? `Password: <span class="password-box">${m.initial_password}</span>`
                    : '<span class="sub-info"><i>Password telah diubah</i></span>';

                tbody.innerHTML += `
                    <tr>
                        <td style="text-align:center; color:#888;">${index + 1}</td>
                        <td>
                            <strong style="font-size: 14px; color: #2c3e50;">${m.nama}</strong>
                            <span class="sub-info">NIM: ${m.nim}</span>
                        </td>
                        <td>
                            <a href="mailto:${m.email}" class="email-link">
                                <i class="fas fa-envelope"></i> ${m.email || '-'}
                            </a>
                            <span class="sub-info">${passText}</span>
                        </td>
                        <td style="text-align:center;"><span class="category-badge">Tingkat ${m.tingkat}</span></td>
                        <td style="font-size: 13px;">${m.prodi}</td>
                        <td><a href="tel:${m.no_hp}" class="telp-link"><i class="fas fa-phone-alt"></i> ${m.no_hp || '-'}</a></td>
                        <td>
                            <div class="action-buttons">
                                <button class="edit-btn" onclick="editMahasiswa('${m.nim}')"><i class="fas fa-edit"></i></button>
                                <button class="delete-btn" onclick="openDeleteModal('${m.nim}', '${m.nama}')"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
            });
        }

        function filterTable() {
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            const tingkatVal = document.getElementById('filterTingkat').value;
            const filtered = allMahasiswaData.filter(m => {
                const matchesSearch = m.nama.toLowerCase().includes(searchVal) || m.nim.toString().includes(searchVal);
                const matchesTingkat = tingkatVal === "" || m.tingkat.toString() === tingkatVal;
                return matchesSearch && matchesTingkat;
            });
            renderTable(filtered);
        }

        window.editMahasiswa = (nim) => {
            localStorage.setItem('editMahasiswaNim', nim);
            window.location.href = 'edit_mahasiswa.html';
        };

        function openDeleteModal(nim, nama) {
            nimToDelete = nim;
            document.getElementById('namaHapus').innerText = nama;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() { document.getElementById('deleteModal').classList.remove('show'); }

        document.getElementById('confirmDeleteBtn').onclick = async () => {
            const fd = new FormData();
            fd.append('nim', nimToDelete);
            const res = await fetch('../../../backend/api/mahasiswa/delete.php', { method: 'POST', body: fd });
            const result = await res.json();
            if (result.success) { showToast('Mahasiswa berhasil dihapus'); fetchMahasiswa(); }
            closeDeleteModal();
        };

        // Logout
        document.getElementById('logoutTrigger').onclick = (e) => { e.preventDefault(); document.getElementById('logoutModal').classList.add('show'); };
        document.getElementById('cancelLogoutBtn').onclick = () => document.getElementById('logoutModal').classList.remove('show');
        document.getElementById('confirmLogoutBtn').onclick = async () => {
            try {
                await fetch('../../../backend/api/auth/logout.php', { method: 'POST' });

                // Hapus penanda login di browser agar landing page tahu status sudah logout
                localStorage.removeItem('admin_status');

                // Redirect ke index
                window.location.href = '../../public/index.html';
            } catch (error) {
                console.error("Logout gagal", error);
            }
        };

        function showToast(message) {
            const container = document.getElementById('toastNotificationContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-success show`;
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        document.addEventListener('DOMContentLoaded', fetchMahasiswa);
    </script>
</body>

</html>