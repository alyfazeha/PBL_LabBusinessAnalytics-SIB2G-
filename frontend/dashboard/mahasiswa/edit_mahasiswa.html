<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Mahasiswa | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/cssadmin.css">
    <link rel="stylesheet" href="../../assets/css/cssmahasiswa.css">

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            text-align: center;
        }
        .btn-secondary {
            background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;
        }
        .btn-primary {
            background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="sidebar">
        <div class="logo-area">
            <h3>Lab Admin</h3>
        </div>
        <nav>
            <a href="../admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="../peminjaman/peminjaman.html"><i class="fas fa-calendar-alt"></i> Peminjaman</a>
            <a href="../konten/konten.html"><i class="fas fa-newspaper"></i> Berita & Konten</a>
            <a href="../publikasi/publikasi.html"><i class="fas fa-book"></i> Publikasi</a>
            <a href="../dosen/dosen.html"><i class="fas fa-users"></i> Data Dosen</a>
            <a href="mahasiswa.html" class="active"><i class="fas fa-user-graduate"></i> Data Mahasiswa</a>
            <a href="#" id="logoutTrigger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <header>
            <div class="page-title-group">
                <a href="mahasiswa.html" class="back-icon-link"><i class="fas fa-arrow-left"></i></a>
                <h1>Edit Data Mahasiswa <span id="headerNimDisplay"></span></h1>
            </div>
        </header>

        <div class="data-section">
            <div id="message" class="message-area" style="display: none;"></div>

            <form id="editMahasiswaForm" class="data-form">

                <div class="form-group">
                    <label for="nim">NIM (Tidak dapat diubah)</label>
                    <input type="text" id="nim" name="nim" required placeholder="NIM Mahasiswa" readonly style="background-color: #e9ecef; cursor: not-allowed; color: #555;">
                </div>

                <div class="form-group">
                    <label for="nama">Nama Lengkap (*)</label>
                    <input type="text" id="nama" name="nama" required>
                </div>

                <div class="form-group">
                    <label for="prodi">Program Studi (*)</label>
                    <select id="prodi" name="prodi" required>
                        <option value="D-II PPLS">D-II PPLS</option>
                        <option value="D-IV Teknik Informatika">D-IV Teknik Informatika</option>
                        <option value="D-IV Sistem Informasi Bisnis">D-IV Sistem Informasi Bisnis</option>
                        <option value="S2 Magister Terapan">S2 Magister Terapan</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tingkat">Tingkat/Semester (*)</label>
                    <select id="tingkat" name="tingkat" required>
                        <option value="">-- Pilih Tingkat --</option>
                        <option value="1">Tingkat 1</option>
                        <option value="2">Tingkat 2</option>
                        <option value="3">Tingkat 3</option>
                        <option value="4">Tingkat 4</option>
                        <option value="S2">S2</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="email">Email (*)</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="no_hp">Nomor HP</label>
                    <input type="text" id="no_hp" name="no_hp" placeholder="Contoh: 081234567890">
                </div>

                <button type="submit" id="btnSimpan" class="submit-button"><i class="fas fa-sync-alt"></i> Update Mahasiswa</button>
            </form>
        </div>
    </div>

    <div id="logoutModal" class="modal">
        <div class="modal-content">
            <h2>Konfirmasi Logout</h2>
            <p>Apakah Anda yakin ingin keluar?</p>
            <div style="margin-top: 20px;">
                <button id="cancelLogoutBtn" class="btn-secondary">Batal</button>
                <button id="confirmLogoutBtn" class="btn-primary">Logout</button>
            </div>
        </div>
    </div>
    
    <script>
    const API_BASE_URL = '../../../backend/api/mahasiswa/';
    const AUTH_LOGOUT_URL = '../../../backend/api/auth/logout.php';
    
    // 1. FUNGSI: Mengisi Form dengan Data Lama
    async function loadData() {
        const nimTarget = localStorage.getItem('editMahasiswaNim');
        console.log("NIM target dari LocalStorage:", nimTarget); 

        if (!nimTarget) {
            alert("Error: NIM mahasiswa tidak terdeteksi. Kembali ke halaman daftar.");
            window.location.href = 'mahasiswa.html';
            return;
        }

        try {
            const url = `${API_BASE_URL}detail.php?nim=${nimTarget}`;
            const response = await fetch(url);
            
            if (!response.ok) {
                console.error(`Gagal ambil data. Status: ${response.status}`);
                alert(`Gagal mengambil data mahasiswa. Status: ${response.status}`);
                return;
            }
            
            let mhs;
            try {
                const json = await response.json();
                mhs = json.data || json; 
            } catch (e) {
                console.error("Error parsing JSON:", e);
                alert("Error: Data dari server bukan JSON yang valid.");
                return;
            }

            if (mhs && mhs.nim) {
                // Isi Form
                document.getElementById('nim').value = mhs.nim; // Akan terisi tapi readonly
                document.getElementById('nama').value = mhs.nama;
                document.getElementById('prodi').value = mhs.prodi;
                document.getElementById('tingkat').value = mhs.tingkat;
                document.getElementById('no_hp').value = mhs.no_hp;
                document.getElementById('email').value = mhs.email;
                
                // Update Judul Kecil
                const headerNim = document.getElementById('headerNimDisplay');
                if(headerNim) headerNim.textContent = `: ${mhs.nim}`;
                
            } else {
                alert("Data mahasiswa tidak ditemukan (kosong).");
                window.location.href = 'mahasiswa.html';
            }

        } catch (error) {
            console.error("Fatal Fetch Error:", error);
            alert("Terjadi kesalahan koneksi server.");
        }
    }

    // 2. FUNGSI: Simpan Perubahan (Update)
    document.getElementById('editMahasiswaForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const btnSimpan = document.getElementById('btnSimpan');
        const originalText = btnSimpan.innerHTML;
        btnSimpan.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
        btnSimpan.disabled = true;

        const formData = new FormData(this);
        
        try {
            const response = await fetch(`${API_BASE_URL}update.php`, {
                method: 'POST',
                body: formData
            });
            
            let result;
            try {
                result = await response.json();
            } catch (e) {
                alert("Error: Respon server bukan JSON.");
                console.log(await response.text()); 
                btnSimpan.innerHTML = originalText;
                btnSimpan.disabled = false;
                return;
            }

            if (result.success) {
                alert('Data mahasiswa berhasil diperbarui!');
                localStorage.removeItem('editMahasiswaNim'); 
                window.location.href = 'mahasiswa.html';
            } else {
                alert('Gagal update: ' + (result.message || 'Terjadi kesalahan.'));
                btnSimpan.innerHTML = originalText;
                btnSimpan.disabled = false;
            }

        } catch (error) {
            console.error('Update Error:', error);
            alert('Terjadi kesalahan jaringan/server.');
            btnSimpan.innerHTML = originalText;
            btnSimpan.disabled = false;
        }
    });

    // Jalankan loadData saat halaman siap
    document.addEventListener('DOMContentLoaded', loadData);

    // --- LOGIC LOGOUT ---
    const logoutTrigger = document.getElementById('logoutTrigger');
    const logoutModal = document.getElementById('logoutModal');
    const cancelLogoutBtn = document.getElementById('cancelLogoutBtn');
    const confirmLogoutBtn = document.getElementById('confirmLogoutBtn');
    const closeModal = document.querySelector('.close'); // Cek jika ada tombol X

    function toggleModal(show) {
        if (logoutModal) {
            if (show) {
                logoutModal.classList.add('show');
            } else {
                logoutModal.classList.remove('show');
            }
        }
    }

    if(logoutTrigger) {
        logoutTrigger.addEventListener('click', (e) => {
            e.preventDefault();
            toggleModal(true);
        });
    }

    if(cancelLogoutBtn) {
        cancelLogoutBtn.addEventListener('click', () => toggleModal(false));
    }
    
    // Pengecekan aman untuk tombol close
    if (closeModal) {
        closeModal.addEventListener('click', () => toggleModal(false));
    }

    window.onclick = (event) => {
        if (event.target == logoutModal) toggleModal(false);
    };

    if(confirmLogoutBtn) {
        confirmLogoutBtn.addEventListener('click', async () => {
            try {
                await fetch(AUTH_LOGOUT_URL, { method: 'POST' });
                window.location.href = '../../public/index.html';
            } catch (error) {
                console.error('Logout Error:', error);
                window.location.href = '../../public/index.html';
            }
        });
    }
    </script>
</body>
</html>