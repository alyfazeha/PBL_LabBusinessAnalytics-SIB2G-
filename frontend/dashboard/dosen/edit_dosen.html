<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Dosen | Admin</title>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../assets/css/cssadmin.css">
    <link rel="stylesheet" href="../../assets/css/cssmahasiswa.css">
</head>

<body>
    <div id="toastNotificationContainer"></div>

    <div class="sidebar">
        <div class="logo-area">
            <h3>Lab Admin</h3>
        </div>
        <nav>
            <a href="../admin.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="../peminjaman/peminjaman.html"><i class="fas fa-calendar-alt"></i> Peminjaman</a>
            <a href="../konten/konten.html"><i class="fas fa-newspaper"></i> Berita & Konten</a>
            <a href="../publikasi/publikasi.html"><i class="fas fa-book"></i> Publikasi</a>
            <a href="dosen.html" class="active"><i class="fas fa-users"></i> Data Dosen</a>
            <a href="../mahasiswa/mahasiswa.html"><i class="fas fa-user-graduate"></i> Data Mahasiswa</a>
            <a href="#" id="logoutTrigger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </div>

    <div class="main-content">
        <header>
            <div class="header-title">
                <a href="dosen.html" class="back-icon-in-header"><i class="fas fa-arrow-left"></i></a>
                <h2>Edit Data Dosen: <span id="dosen-nidn-display"
                        style="font-size: 0.7em; opacity: 0.6;">[Memuat...]</span></h2>
            </div>
            <div></div>
        </header>

        <main>
            <div class="form-card">
                <div class="form-card-header"></div>

                <form id="editDosenForm" class="data-form">
                    <input type="hidden" id="input-nidn-key" name="nidn">
                    <input type="hidden" id="input-user_id" name="user_id">
                    <input type="hidden" id="input-foto-lama" name="foto_lama">
                    <div class="form-grid-2">
                        <div class="column-left">
                            <h4 style="color: var(--primary-blue);"><i class="fas fa-id-card"></i> Identitas Dosen</h4>
                            <div class="form-group">
                                <label for="input-nidn">NIDN (Read Only)</label>
                                <input type="text" id="input-nidn" readonly
                                    style="background-color: #f9f9f9; cursor: not-allowed;">
                            </div>
                            <div class="form-group">
                                <label for="input-nip">NIP <span class="required">*</span></label>
                                <input type="text" id="input-nip" name="nip" required>
                            </div>
                            <div class="form-group">
                                <label for="input-nama">Nama Lengkap <span class="required">*</span></label>
                                <input type="text" id="input-nama" name="nama" required>
                            </div>
                            <div class="form-group">
                                <label for="input-email">Email <span class="required">*</span></label>
                                <input type="email" id="input-email" name="email" required>
                            </div>

                            <div class="form-group">
                                <label for="input-matkul">Mata Kuliah Diampu:</label>
                                <textarea id="input-matkul" name="mata_kuliah" rows="3" required></textarea>
                            </div>
                        </div>

                        <div class="column-right">
                            <h4 style="color: var(--primary-blue);"><i class="fas fa-briefcase"></i> Akademik & Jabatan
                            </h4>
                            <div class="form-group">
                                <label for="input-jabatan">Jabatan <span class="required">*</span></label>
                                <select id="input-jabatan" name="jabatan" required>
                                    <option value="Tenaga Pengajar">Tenaga Pengajar</option>
                                    <option value="Asisten Ahli">Asisten Ahli</option>
                                    <option value="Lektor">Lektor</option>
                                    <option value="Lektor Kepala">Lektor Kepala</option>
                                    <option value="Guru Besar">Guru Besar</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="input-prodi">Program Studi <span class="required">*</span></label>
                                <select id="input-prodi" name="prodi" required>
                                    <option value="D-IV Teknik Informatika">D-IV Teknik Informatika</option>
                                    <option value="D-IV Sistem Informasi Bisnis">D-IV Sistem Informasi Bisnis</option>
                                    <option value="D-II Pengembangan Perangkat (Piranti) Lunak Situs">D-II Pengembangan
                                        Perangkat (Piranti) Lunak Situs</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="input-pendidikan">Pendidikan Terakhir <span
                                        class="required">*</span></label>
                                <input type="text" id="input-pendidikan" name="pendidikan" required>
                            </div>
                            <h4 style="color: var(--primary-blue);"><i class="fas fa-camera"></i> Foto Profil</h4>
                            <div id="foto-preview-area"
                                style="margin-bottom: 15px; display: flex; align-items: center; gap: 15px;">
                                <img id="current-foto" src="" alt="Preview"
                                    style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 2px solid #ddd; display: none;">
                                <p id="no-foto-text" style="color: #888; font-style: italic; margin: 0;">Belum ada foto.
                                </p>
                            </div>

                            <div class="file-upload-wrapper">
                                <div class="file-upload-container">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>Klik atau Tarik File Gambar Baru</p>
                                    <input type="file" id="input-foto" name="foto_file" accept="image/jpeg,image/png">
                                </div>
                                <span id="fileNameDisplay" class="file-name-display">Belum ada file dipilih</span>
                            </div>

                            <div class="form-group" style="margin-top: 15px;">
                                <label for="foto_path_url">Atau Ganti dengan URL Foto:</label>
                                <input type="text" name="foto_path" id="foto_path_url"
                                    placeholder="https://website.com/foto.jpg">
                            </div>
                            <small style="color: #666;">Biarkan kosong jika tidak ingin mengubah foto saat ini.</small>
                            <div class="form-actions full-width" style="margin-top: 50px;">
                                <button type="submit" id="submitBtn" class="btn btn-ijo">
                                    <i class="fas fa-save"></i> Simpan Dosen
                                </button>
                                <a href="dosen.html" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Batal
                                </a>
                            </div>
                        </div>
                    </div>
                </form>




            </div>
        </main>
    </div>


    <div id="logoutModal" class="modal logout-modal" style="display: none;">
        <div class="modal-content" style="text-align: left !important;">
            <h4><i class="fas fa-sign-out-alt"></i> Konfirmasi Logout</h4>
            <p>Apakah Anda yakin ingin mengakhiri sesi Admin?</p>
            <div class="modal-buttons">
                <button id="cancelLogout" class="btn btn-secondary">Batal</button>
                <button id="confirmLogout" class="btn btn-danger">Logout</button>
            </div>
        </div>
    </div>

    <script>
        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastNotificationContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            toast.innerHTML = `<i class="fas ${icon} toast-icon"></i><div class="toast-text">${message}</div>`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- FETCH DETAIL DATA (AUTO-FILL) ---
        async function fetchDosenDetail() {
            const params = new URLSearchParams(window.location.search);
            const nidn = params.get('nidn');

            if (!nidn) {
                showToast('NIDN tidak ditemukan di URL!', 'error');
                return;
            }

            try {
                const response = await fetch(`../../../backend/api/dosen/detail.php?nidn=${nidn}`);
                const data = await response.json();

                if (data && data.nidn) {
                    // Isi Kunci Update
                    document.getElementById('input-nidn-key').value = data.nidn;
                    document.getElementById('input-user_id').value = data.user_id;

                    // --- TAMBAHKAN INI: Simpan path foto lama ---
                    if (document.getElementById('input-foto-lama')) {
                        document.getElementById('input-foto-lama').value = data.foto_path || '';
                    }

                    // Isi Field Form
                    document.getElementById('input-nidn').value = data.nidn;
                    document.getElementById('input-nip').value = data.nip || '';
                    document.getElementById('input-nama').value = data.nama || '';
                    document.getElementById('input-email').value = data.email || '';
                    document.getElementById('input-jabatan').value = data.jabatan || '';
                    document.getElementById('input-prodi').value = data.prodi || '';
                    document.getElementById('input-pendidikan').value = data.pendidikan || '';
                    document.getElementById('input-matkul').value = data.mata_kuliah || '';
                    document.getElementById('dosen-nidn-display').textContent = `(${data.nidn})`;

                    /// Logika Preview Foto yang lebih aman
                    const currentFoto = document.getElementById('current-foto');
                    const noFotoText = document.getElementById('no-foto-text');
                    const urlInput = document.getElementById('foto_path_url');
                    const fotoPath = data.foto_path;

                    if (fotoPath && fotoPath !== "") {
                        // Tampilkan gambar
                        currentFoto.src = fotoPath.startsWith('http') ? fotoPath : `../../${fotoPath}`;
                        currentFoto.style.display = 'block';
                        noFotoText.style.display = 'none';

                        // HANYA isi kotak URL jika memang datanya berupa link (http)
                        if (fotoPath.startsWith('http')) {
                            urlInput.value = fotoPath;
                        } else {
                            // Jika file lokal, biarkan input URL kosong agar tidak menimpa data saat update
                            urlInput.value = "";
                        }
                    }
                } else {
                    showToast('Gagal mengambil detail dosen.', 'error');
                }
            } catch (err) {
                showToast('Kesalahan memuat data.', 'error');
            }
        }

        // --- DISPLAY SELECTED FILE NAME ---
        const inputFoto = document.getElementById('input-foto');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        inputFoto.addEventListener('change', () => {
            fileNameDisplay.textContent = inputFoto.files.length > 0 ? inputFoto.files[0].name : 'Belum ada file dipilih';
        });

        // --- SUBMIT UPDATE ---
        const form = document.getElementById('editDosenForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            const formData = new FormData(form);

            try {
                const response = await fetch('../../../backend/api/dosen/update.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.success) {
                    showToast('Data Dosen berhasil diperbarui!');
                    setTimeout(() => window.location.href = 'dosen.html', 2000);
                } else {
                    showToast(result.message || 'Gagal update data', 'error');
                }
            } catch (error) {
                showToast('Kesalahan server atau koneksi', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // --- LOGOUT LOGIC ---
        const logoutTrigger = document.getElementById('logoutTrigger');
        const logoutModal = document.getElementById('logoutModal');
        logoutTrigger.onclick = (e) => { e.preventDefault(); logoutModal.style.display = 'flex'; };
        document.getElementById('cancelLogout').onclick = () => logoutModal.style.display = 'none';
        document.getElementById('confirmLogout').onclick = async () => {
            await fetch('../../../backend/api/auth/logout.php', { method: 'POST' });
            window.location.href = '../../public/index.html';
        };

        // --- START UP ---
        document.addEventListener('DOMContentLoaded', fetchDosenDetail);
    </script>
</body>

</html>