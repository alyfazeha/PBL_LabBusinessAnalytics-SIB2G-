<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mahasiswa | Lab Business Analytics</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="../assets/css/cssadmin.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f4f7fe;
        }

        /* --- STATS GRID MODERN --- */
        .stats-grid-mhs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 35px;
        }

        .stat-card-new {
            padding: 30px 25px;
            border-radius: 20px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.05);
            border: none;
        }

        .stat-card-new:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
            filter: brightness(1.05);
        }

        .stat-card-new.green {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .stat-card-new.orange {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .stat-card-new.blue {
            background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%);
        }

        .stat-card-new .info h2 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .stat-card-new .info p {
            font-size: 0.95rem;
            font-weight: 500;
            margin: 5px 0 0;
            opacity: 0.9;
        }

        .stat-card-new i {
            font-size: 3.5rem;
            opacity: 0.25;
            transition: all 0.3s ease;
        }

        /* --- TABLE SECTION --- */
        .recent-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.04);
        }

        .table-wrapper {
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #edf2f7;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead th {
            background-color: #4A90E2;
            color: #ffffff;
            text-transform: uppercase;
            font-size: 11px;
            font-weight: 700;
            padding: 18px 15px;
            text-align: left;
        }

        .data-table tbody td {
            padding: 16px 15px;
            font-size: 13px;
            color: #4a5568;
            border-bottom: 1px solid #f1f5f9;
        }



        /* Style untuk info waktu di tabel */
        .time-info-wrapper {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .time-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-info-item i {
            color: #4A90E2;
            width: 14px;
            text-align: center;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="logo-area">
            <img src="../assets/images/LogoPolinema.png" alt="" style="width: 50px;">
            <img src="../assets/images/logoJTI.png" alt="" style="width: 45px;">
            <img src="../assets/images/LogoLab2.png" alt="Logo"
                style="width: 70px; margin-bottom: -10px; margin-left: -10px;">
            <h3>Dashboard Mahasiswa</h3>
        </div>
        <nav>
            <a href="index.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="../public/index.html"
                style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 10px; padding-top: 15px;">
                <i class="fas fa-external-link-alt"></i> Lihat Landing Page
            </a>
            <a href="profile.html"><i class="fas fa-user-circle"></i> Profil & Akun</a>
            <a href="peminjaman.html"><i class="fas fa-calendar-plus"></i> Pinjam Sarana</a>
            <a href="riwayat.html"><i class="fas fa-history"></i> Riwayat Pinjam</a>
            <a href="#" id="logoutTrigger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
    </aside>

    <main class="main-content">
        <header style="margin-bottom: 35px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px;">
            <h1 style="font-size: 1.8rem; color: #2d3748; margin: 0; font-weight: 700;">Halo, <span id="welcomeMsg"
                    style="color: #4A90E2;">Mahasiswa</span>! ðŸ‘‹</h1>
            <p id="profileSummary" style="color: #718096; margin-top: 5px;">NIM: -, Prodi: -</p>
        </header>

        <div class="stats-grid-mhs">
            <div class="stat-card-new green">
                <div class="info">
                    <h2 id="countApproved">0</h2>
                    <p>Disetujui</p>
                </div>
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-card-new orange">
                <div class="info">
                    <h2 id="countPending">0</h2>
                    <p>Menunggu</p>
                </div>
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-card-new blue">
                <div class="info">
                    <h2 id="totalBooking">0</h2>
                    <p>Total Pengajuan</p>
                </div>
                <i class="fas fa-clipboard-list"></i>
            </div>
        </div>

        <div class="recent-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0; color: #2d3748; font-size: 1.2rem; font-weight: 700;">
                    <i class="fas fa-calendar-day" style="color: #4A90E2; margin-right: 10px;"></i> Jadwal Peminjaman
                    Anda
                </h3>
                <a href="riwayat.html"
                    style="font-size: 0.85rem; color: #4A90E2; font-weight: 600; text-decoration: none;">
                    Riwayat Lengkap <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                </a>
            </div>

            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 80px;">ID</th>
                            <th>Waktu Pelaksanaan</th>
                            <th>Sarana / Ruang</th>
                            <th>Dosen PJ</th>
                            <th style="text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody id="latestBookingList">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 50px; color: #a0aec0;">
                                <i class="fas fa-circle-notch fa-spin fa-2x"></i>
                                <p style="margin-top: 10px;">Menyelaraskan jadwal...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="logoutModal" class="modal logout-modal">
        <div class="modal-content">
            <span class="close-btn"
                onclick="document.getElementById('logoutModal').style.display='none';">&times;</span>
            <h4><i class="fas fa-sign-out-alt"></i> Konfirmasi Logout</h4>
            <p>Apakah Anda yakin ingin keluar dari sistem dashboard mahasiswa?</p>
            <div class="modal-buttons">
                <button onclick="document.getElementById('logoutModal').style.display='none';"
                    class="btn btn-secondary">Batal</button>
                <button id="confirmLogoutBtn" class="btn btn-danger">Ya, Logout</button>
            </div>
        </div>
    </div>



    <script>
        const API_BASE_URL = '../../backend/api/';

        function formatTanggalRingkas(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        async function loadDashboard() {
            try {
                // 1. Profil
                const resProfile = await fetch(API_BASE_URL + 'mahasiswa/detail.php');
                const resultMhs = await resProfile.json();
                if (resultMhs.success) {
                    document.getElementById('welcomeMsg').textContent = resultMhs.data.nama;
                    document.getElementById('profileSummary').textContent = `NIM: ${resultMhs.data.nim} | Prodi: ${resultMhs.data.prodi}`;
                }

                // 2. Booking Data
                const resBooking = await fetch(API_BASE_URL + 'booking/list.php');
                const resultBooking = await resBooking.json();
                const data = resultBooking.data || [];

                // 3. Stats
                let approved = 0, pending = 0;
                data.forEach(item => {
                    const s = item.status.toLowerCase();
                    if (s === 'disetujui') approved++;
                    if (s === 'diajukan' || s === 'pending') pending++;
                });
                document.getElementById('countApproved').textContent = approved;
                document.getElementById('countPending').textContent = pending;
                document.getElementById('totalBooking').textContent = data.length;

                // 4. Render Table (No Action Column)
                const listContainer = document.getElementById('latestBookingList');
                listContainer.innerHTML = '';

                if (data.length > 0) {
                    const latest = data.slice(0, 5);
                    latest.forEach(item => {
                        const statusUpper = item.status.toUpperCase();
                        const tglDisplay = formatTanggalRingkas(item.tanggal);
                        const jamMulai = item.start_time ? item.start_time.substring(0, 5) : '--:--';
                        const jamSelesai = item.end_time ? item.end_time.substring(0, 5) : '--:--';

                        listContainer.innerHTML += `
                            <tr>
                                <td style="font-weight: 700; color: #4A90E2;">#${item.booking_id}</td>
                                <td>
                                    <div class="time-info-wrapper">
                                        <div class="time-info-item">
                                            <i class="far fa-calendar-alt"></i>
                                            <span style="font-weight: 600; color: #2d3748;">${tglDisplay}</span>
                                        </div>
                                        <div class="time-info-item">
                                            <i class="far fa-clock"></i>
                                            <span style="font-size: 11px; color: #718096;">${jamMulai} - ${jamSelesai} WIB</span>
                                        </div>
                                    </div>
                                </td>
                                <td style="font-weight: 600; color: #2d3748;">${item.nama_sarana || 'Ruangan Lab'}</td>
                                <td>${item.nama_dosen || '-'}</td>
                                <td style="text-align: center;">
                                    <span class="status ${statusUpper}">${statusUpper}</span>
                                </td>
                            </tr>
                        `;
                    });
                } else {
                    listContainer.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px; color:#a0aec0;">Belum ada jadwal peminjaman tercatat.</td></tr>';
                }
            } catch (error) {
                console.error("Dashboard error:", error);
            }
        }

        // Logout Logic
        const logoutModal = document.getElementById('logoutModal');
        const logoutTrigger = document.getElementById('logoutTrigger');
        if (logoutTrigger) {
            logoutTrigger.onclick = (e) => {
                e.preventDefault();
                logoutModal.style.display = 'flex';
            };
        }

        document.getElementById('confirmLogoutBtn').onclick = async () => {
            try {
                await fetch('../../backend/api/auth/logout.php', { method: 'POST' });

                // Hapus penanda agar tombol dashboard di landing page hilang
                localStorage.removeItem('dosen_status');

                window.location.href = '../public/index.html';
            } catch (error) {
                console.error("Logout gagal", error);
            }
        };

        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>