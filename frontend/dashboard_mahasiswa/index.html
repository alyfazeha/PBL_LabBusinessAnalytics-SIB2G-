<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Mahasiswa - Peminjaman</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../../frontend/assets/css/dashboardmhs.css">

    <style>
        /* --- CSS BAWAAN (TIDAK DIUBAH) --- */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-card h3 {
            margin-top: 0;
            font-size: 0.9rem;
            color: #666;
            font-weight: 500;
        }

        .status-card p {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 0;
            line-height: 1;
        }

        .status-icon i {
            font-size: 3rem;
            opacity: 0.3;
        }

        .status-card.approved { border-left: 5px solid #28a745; }
        .status-card.pending { border-left: 5px solid #ffc107; }
        .status-card.rejected { border-left: 5px solid #dc3545; }
        
        /* Badge Status */
        .status-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        .status-diajukan, .status-pending { background-color: #ffc107; color: #333; }
        .status-disetujui { background-color: #28a745; color: white; }
        .status-ditolak, .status-dibatalkan { background-color: #dc3545; color: white; }

        .loading-text, .empty-text {
            text-align: center;
            color: #999;
            padding: 20px;
        }

        .btn-check-status {
            display: block;
            text-align: right;
            margin-top: 20px;
            text-decoration: none;
            color: #007bff;
            font-weight: 600;
            transition: color 0.3s;
        }
        .btn-check-status:hover { color: #0056b3; }

        /* --- TAMBAHAN KECIL UNTUK FORMAT DETAIL (Agar Rapi) --- */
        .latest-booking-detail {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .detail-row {
            display: flex;
            margin-bottom: 10px;
            font-size: 0.95rem;
            align-items: flex-start;
        }
        .detail-row label {
            width: 140px; /* Lebar label tetap agar sejajar */
            font-weight: 600;
            color: #555;
            flex-shrink: 0;
        }
        .detail-row span {
            color: #333;
            flex: 1;
        }
    </style>
</head>

<body>
    <aside class="mhs-sidebar">
        <div class="mhs-logo-area">
            <h2><i class="fas fa-graduation-cap"></i> MAHASISWA DASHBOARD</h2>
        </div>
        <nav>
            <hr style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
            <a href="index.html" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="profile.html"><i class="fas fa-user-circle"></i> Profil</a>
            <a href="peminjaman.html"><i class="fas fa-laptop-code"></i> Ajukan Peminjaman</a>
            <a href="riwayat.html"><i class="fas fa-history"></i> Status & Riwayat</a>
            <hr style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
            <a href="../public/index.html"><i class="fas fa-home"></i> Landing Page</a>
            <a href="#" id="logoutLink"><i class="fas fa-sign-out-alt"></i> Logout</a>
            <hr style="border-top: 1px solid rgba(255,255,255,0.1); margin: 15px 0;">
        </nav>
    </aside>

    <main class="main-content">
        <header class="dashboard-header">
            <h1 id="welcomeMsg">Selamat Datang!</h1>
            <p id="profileSummary">NIM: -, Prodi: -</p>
        </header>

        <div class="status-grid">
            <div class="status-card approved">
                <div class="status-info">
                    <h3>Peminjaman Disetujui</h3>
                    <p id="countApproved">0</p>
                </div>
                <div class="status-icon" style="color:#28a745;"><i class="fas fa-check-circle"></i></div>
            </div>
            
            <div class="status-card pending">
                <div class="status-info">
                    <h3>Menunggu Persetujuan</h3>
                    <p id="countPending">0</p>
                </div>
                <div class="status-icon" style="color:#ffc107;"><i class="fas fa-clock"></i></div>
            </div>
            
            <div class="status-card rejected">
                <div class="status-info">
                    <h3>Ditolak/Dibatalkan</h3>
                    <p id="countRejected">0</p>
                </div>
                <div class="status-icon" style="color:#dc3545;"><i class="fas fa-times-circle"></i></div>
            </div>
        </div>

        <div class="content-card">
            <h2><i class="fas fa-star"></i> Pengajuan Peminjaman Terbaru Anda!</h2>
            
            <div id="latestBookingDetail" class="latest-booking-detail">
                <div class="loading-text"><i class="fas fa-spinner fa-spin"></i> Memuat data...</div>
            </div>

            <a href="riwayat.html" class="btn-check-status">
                Cek Semua Status & Riwayat Peminjaman <i class="fas fa-arrow-right"></i>
            </a>
        </div>
    </main>

    <script>
        // Sesuaikan path ke backend
        const API_BASE_URL = '../../backend/api/';
        const API_DETAIL = API_BASE_URL + 'mahasiswa/detail.php';
        const API_BOOKING_LIST = API_BASE_URL + 'booking/list.php';

        // Fungsi untuk mengambil data profil dan mengisi header
        async function loadProfileHeader() {
            try {
                const response = await fetch(API_DETAIL);
                const result = await response.json();

                if (result.success && result.data) {
                    const mhs = result.data;
                    document.getElementById('welcomeMsg').textContent = `Selamat Datang, ${mhs.nama}!`;
                    document.getElementById('profileSummary').textContent = `NIM: ${mhs.nim}, Prodi: ${mhs.prodi}`;
                } else {
                    window.location.href = '../../public/index.html';
                }
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        }

        // Fungsi untuk mengambil dan menghitung statistik peminjaman
        async function loadBookingStats() {
            try {
                const response = await fetch(API_BOOKING_LIST);
                const result = await response.json();
                const data = result.data || [];

                let approved = 0;
                let pending = 0;
                let rejected = 0;

                data.forEach(item => {
                    const status = item.status.toLowerCase();
                    if (status === 'disetujui') {
                        approved++;
                    } else if (status === 'diajukan' || status === 'pending') {
                        pending++;
                    } else if (status === 'ditolak' || status === 'dibatalkan') {
                        rejected++;
                    }
                });

                document.getElementById('countApproved').textContent = approved;
                document.getElementById('countPending').textContent = pending;
                document.getElementById('countRejected').textContent = rejected;
                
                return data; // Kembalikan data untuk fungsi detail terbaru
            } catch (error) {
                console.error("Error loading booking stats:", error);
                document.getElementById('countApproved').textContent = '?';
                document.getElementById('countPending').textContent = '?';
                document.getElementById('countRejected').textContent = '?';
                return [];
            }
        }

        // Fungsi Baru: Menampilkan 1 Data Terbaru dengan Format Detail
        async function loadLatestBooking(data) {
            const container = document.getElementById('latestBookingDetail');
            
            // Cek jika data kosong
            if (!data || data.length === 0) {
                 // Coba load lagi jika data belum ada (opsional)
                 data = await loadBookingStats();
                 if (data.length === 0) {
                    container.innerHTML = '<div class="empty-text">Belum ada pengajuan peminjaman.</div>';
                    return;
                 }
            }
            
            // 1. Sortir data berdasarkan ID terbaru (Descending)
            data.sort((a, b) => b.booking_id - a.booking_id);
            
            // 2. Ambil Data Pertama (Terbaru)
            const item = data[0]; 

            // 3. Format Data
            const statusClass = item.status.toLowerCase().replace(' ', '-');
            const dateDisplay = new Date(item.tanggal).toLocaleDateString('id-ID', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            const jamMulai = item.start_time ? item.start_time.substring(0, 5) : '--:--';
            const jamSelesai = item.end_time ? item.end_time.substring(0, 5) : '--:--';

            // 4. Render HTML Format Detail (Label : Nilai)
            container.innerHTML = `
                <div class="detail-row">
                    <label>Tanggal Booking</label>
                    <span>: ${dateDisplay}</span>
                </div>
                <div class="detail-row">
                    <label>Dosen PJ</label>
                    <span>: ${item.nama_dosen || '-'}</span>
                </div>
                <div class="detail-row">
                    <label>Keperluan</label>
                    <span>: ${item.keperluan}</span>
                </div>
                <div class="detail-row">
                    <label>Waktu</label>
                    <span>: ${jamMulai} - ${jamSelesai} WIB</span>
                </div>
                <div class="detail-row">
                    <label>Status</label>
                    <span>: <span class="status-badge status-${statusClass}">${item.status}</span></span>
                </div>
            `;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            loadProfileHeader();
            // Panggil statistik lalu gunakan datanya untuk detail terbaru
            const allBookings = await loadBookingStats();
            loadLatestBooking(allBookings);
        });

        // Logout Logic
        document.getElementById('logoutLink').addEventListener('click', function (e) {
            e.preventDefault(); 
            const isConfirmed = confirm('Apakah Anda yakin ingin keluar dari sistem?');

            if (isConfirmed) {
                const logoutUrl = '../../backend/api/auth/logout.php';
                fetch(logoutUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    window.location.href = '../public/index.html';
                })
                .catch(error => {
                    console.error('Error saat melakukan logout:', error);
                    window.location.href = '../public/index.html';
                });
            }
        });
    </script>
</body>
</html>