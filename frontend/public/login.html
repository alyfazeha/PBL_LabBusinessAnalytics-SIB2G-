<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login & Register Form</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" href="../assets/css/csslogin.css">
    <link rel="stylesheet" href="../assets/css/cssadmin.css">
</head>

<body>
    <div id="toastNotificationContainer"></div>
    <div class="container" id="container">

        <div class="form-container sign-up-container">
            <form id="registerForm">
                <h1>Registrasi Akun</h1>
                <div class="social-container">
                    <a href="#" class="social"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social"><i class="fab fa-google-plus-g"></i></a>
                    <a href="#" class="social"><i class="fab fa-linkedin-in"></i></a>
                </div>

                <div id="step1" class="step-content active">
                    <span>Pilih peran Anda untuk melanjutkan registrasi</span>
                    <button type="button" class="role-button" data-role="dosen">Saya Seorang Dosen</button>
                    <button type="button" class="role-button" data-role="mahasiswa">Saya Seorang Mahasiswa</button>
                    <input type="hidden" name="role" id="selectedRoleInput" required />
                </div>

                <div id="step2" class="step-content">
                    <span>Masukkan detail data diri Anda</span>

                    <input type="text" placeholder="Nama Tampilan Lengkap" name="display_name" required />
                    <input type="text" placeholder="Username" name="username" required />
                    <input type="email" placeholder="Email (Opsional)" name="email" />
                    <input type="password" placeholder="Kata Sandi" name="password" required />

                    <div id="role_specific_input" style="width: 100%;">
                    </div>

                    <button type="submit">Register</button>
                    <button type="button" class="role-button back-button" onclick="goToStep(1)">Kembali ke
                        pilihan peran</button>
                </div>
            </form>
        </div>

        <div class="form-container sign-in-container">
            <form id="loginForm">
                <h1>Login Sistem</h1>
                <div class="social-container">
                    <a href="#" class="social"><i class="fab fa-facebook-f"></i></a>
                    <a href="#" class="social"><i class="fab fa-google-plus-g"></i></a>
                    <a href="#" class="social"><i class="fab fa-linkedin-in"></i></a>
                </div>
                <span>atau gunakan akun Anda</span>
                <input type="text" placeholder="Username" name="username" required />
                <input type="password" placeholder="Kata Sandi" name="password" required />
                <a href="#">Lupa Kata Sandi?</a>
                <button type="submit">Login</button>
            </form>
        </div>

        <div class="overlay-container">
            <div class="overlay">
                <div class="overlay-panel overlay-left">
                    <h1>Verifikasi Akun</h1>
                    <p>Silakan masuk menggunakan kredensial Anda untuk melanjutkan ke Dashboard Sistem.</p>
                    <button class="ghost" id="signIn">Login</button>
                </div>
                <div class="overlay-panel overlay-right">
                    <h1>Selamat Datang!</h1>
                    <p>Daftarkan akun Anda untuk mengakses layanan dari Laboratorium Business Analytics.</p>
                    <button class="ghost" id="signUp">Register</button>
                </div>
            </div>
        </div>
    </div>

    <a href="index.html" class="floating-preview-btn" title="Lihat Tampilan Depan">
        <div class="pulse-ring"></div>
        <i class="fas fa-eye"></i>
        <span>Lihat Website</span>
    </a>
    <script>
        const signUpButton = document.getElementById('signUp');
        const signInButton = document.getElementById('signIn');
        const container = document.getElementById('container');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        // Elemen Multi-Step
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const roleButtons = document.querySelectorAll('.role-button[data-role]');
        const selectedRoleInput = document.getElementById('selectedRoleInput');
        const roleSpecificInputContainer = document.getElementById('role_specific_input');

        // Logic pindah panel
        signUpButton.addEventListener('click', () => {
            container.classList.add("right-panel-active");
            goToStep(1); // Reset ke Step 1 saat beralih ke register
        });

        signInButton.addEventListener('click', () => {
            container.classList.remove("right-panel-active");
        });

        function showNotification(message, type = 'info') {
            // Normalisasi tipe (jika input boolean dari kode lama)
            if (type === true) type = 'success';
            if (type === false) type = 'error';

            const container = document.getElementById('toastNotificationContainer');
            if (!container) return;

            // Buat elemen toast
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;

            // Tentukan icon berdasarkan tipe
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'error') icon = 'fa-exclamation-circle';

            toast.innerHTML = `
        <div class="toast-icon"><i class="fas ${icon}"></i></div>
        <div class="toast-text">${message}</div>
    `;

            container.appendChild(toast);

            // Trigger animasi muncul
            setTimeout(() => toast.classList.add('show'), 100);

            // Hilangkan otomatis setelah 3.5 detik
            setTimeout(() => {
                toast.classList.replace('show', 'hide');
                setTimeout(() => toast.remove(), 500); // Hapus dari DOM setelah animasi selesai
            }, 3500);
        }

        // --- LOGIC MULTI-STEP REGISTER ---

        function goToStep(step) {
            step1.classList.remove('active');
            step2.classList.remove('active');

            if (step === 1) {
                step1.classList.add('active');
                selectedRoleInput.value = ''; // Kosongkan role saat kembali
            } else if (step === 2) {
                step2.classList.add('active');
            }
        }

        /**
         * Fungsi untuk membuat input dinamis (NIM atau NIDN)
         * PENTING: Gunakan name="nidn" atau name="nim" untuk PHP
         */
        function createRoleInput(role) {
            let html = '';
            if (role === 'dosen') {
                html = '<input type="text" name="nidn" placeholder="NIDN" required />';
            } else if (role === 'mahasiswa') {
                html = '<input type="text" name="nim" placeholder="NIM" required />';
            }
            return html;
        }

        roleButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const role = e.target.dataset.role;
                selectedRoleInput.value = role; // Set nilai role
                roleSpecificInputContainer.innerHTML = createRoleInput(role); // Tampilkan input NIM/NIDN
                goToStep(2); // Pindah ke langkah 2
            });
        });


        // --- LOGIC LOGIN (Diperbarui untuk pengalihan Role) ---
        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(loginForm);
                // Pastikan path ke login.php benar
                const url = '../../backend/api/auth/login.php';

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification(result.message, 'success'); // Gunakan toast success

                        // Beri jeda 1.5 detik agar user bisa baca toast sebelum pindah halaman
                        setTimeout(() => {
                            if (result.data && result.data.role) {
                                switch (result.data.role) {
                                    case 'admin': window.location.href = '../dashboard/admin.html'; break;
                                    case 'mahasiswa': window.location.href = '../dashboard_mahasiswa/index.html'; break;
                                    case 'dosen': window.location.href = '../dashboard_dosen/index.html'; break;
                                    default: window.location.href = 'index.html';
                                }
                            } else {
                                window.location.href = 'index.html';
                            }
                        }, 1500);
                    }

                } catch (error) {
                    showNotification("Error: Terjadi kesalahan jaringan atau server.", false);
                    console.error('Fetch Error:', error);
                }
            });
        }

        // --- LOGIC REGISTER (Diperbarui) ---
        if (registerForm) {
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!selectedRoleInput.value) {
                    showNotification("Silakan pilih peran Anda terlebih dahulu.", false);
                    goToStep(1);
                    return;
                }

                const formData = new FormData(registerForm);
                // Pastikan path ke register.php benar!
                const url = '../../backend/api/auth/register.php';

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        body: formData,
                    });

                    // Kita harus cek status HTTP, karena error 500 dari PHP tidak akan mengembalikan JSON yang valid
                    if (response.status !== 200) {
                        showNotification(`Error: Gagal terhubung ke server. (Status: ${response.status})`, false);
                        return;
                    }

                    const result = await response.json();

                    if (result.success) {
                        showNotification(result.message + " Silakan masuk.", 'success');

                        // Pindah ke form login
                        container.classList.remove("right-panel-active");
                        goToStep(1);
                    }

                } catch (error) {
                    showNotification("Error: Terjadi kesalahan jaringan. Cek server Anda.", false);
                    console.error('Fetch Error:', error);
                }
            });
        }

        document.addEventListener('keydown', function (e) {
            // Jika menekan huruf 'P' (shift + p) saat tidak sedang mengetik di input
            if (e.shiftKey && e.key.toLowerCase() === 'p') {
                if (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
                    window.location.href = 'index.html';
                }
            }
        });
    </script>

</body>

</html>