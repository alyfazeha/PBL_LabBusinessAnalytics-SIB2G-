<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Detail berita dari Business Analytics Laboratory.">
    <meta name="author" content="Business Analytics Laboratory">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500;700;900&display=swap"
        rel="stylesheet">

    <title>Detail Berita | Business Analytics Laboratory</title>

    <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css"
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" href="../assets/css/templatemo-chain-app-dev.css">
    <link rel="stylesheet" href="../assets/css/animated.css">
    <link rel="stylesheet" href="../assets/css/owl.css">

    <link rel="stylesheet" href="../assets/css/beritacss.css">

</head>

<body>
    <header class="header-area header-sticky wow slideInDown" data-wow-duration="0.75s" data-wow-delay="0s">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <nav class="main-nav">
                        <a href="index.html" class="logo" style="margin-top: -7px;">
                            <img src="../assets/images/LogoPolinema.png" alt="" style="width: 60px;">
                            <img src="../assets/images/logoJTI.png" alt="" style="width: 50px;">
                            <img src="../assets/images/LogoLab2.png" alt="Business Analytics Laboratory"
                                style="width: 90px; margin-left: -15px;">
                        </a>
                        <ul class="nav">
                            <li class="scroll-to-section"><a href="index.html">Beranda</a></li>
                            <li class="scroll-to-section"><a href="index.html">Gallery</a></li>
                            <li class="scroll-to-section"><a href="berita.html" class="active">Berita</a></li>
                            <li class="scroll-to-section"><a href="jadwal-lab.html">Jadwal</a></li>
                            <li class="scroll-to-section"><a href="peminjaman-mahasiswa.html">Peminjaman</a></li>
                            <li>
                                <div class="gradient-button"><a id="" href="login.html"><i
                                            class="fa fa-sign-in-alt"></i>
                                        Register | Login</a></div>
                            </li>
                        </ul>
                        <a class='menu-trigger'>
                            <span>Menu</span>
                        </a>
                    </nav>
                </div>
            </div>
        </div>
    </header>
    <div class="page-heading header-text" id="top">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <span class="breadcrumb-item"><a href="index.html">Beranda</a> / <a href="berita.html">Berita</a> /
                        <span id="breadcrumbTitle">Detail</span></span>
                    <h4 id="pageHeadingTitle">Memuat Detail Berita...</h4>
                </div>
            </div>
        </div>
    </div>

    <div id="detail-section" class="section">
        <div class="container">
            <div class="row">

                <div class="col-lg-8">
                    <div id="mainContent" class="berita-detail-content">
                        <div class="loading-message" id="contentLoading">
                            <i class="fa fa-spinner fa-spin"></i> Memuat Konten...
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="sidebar-box">
                        <h4>Berita Terbaru Lainnya</h4>
                        <div id="recentPostsContainer">
                            <p class="loading-message"><i class="fa fa-spinner fa-spin"></i> Memuat...</p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <footer id="newsletter">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <div class="section-heading" style="margin-top: -30px;">
                        <h4>Get to Know Us</h4>
                    </div>
                </div>
                <div class="col-lg-6 offset-lg-3">
                    <form id="search" action="#" method="GET">
                        <div class="row" style="margin-top: -30px; margin-bottom: -50px;">
                            <fieldset>
                                <button class="main-button"><a href="https://www.polinema.ac.id" style="color: #fff; "
                                        target="_blank">Politeknik Negeri
                                        Malang Official
                                        Website</a></button>
                            </fieldset>
                        </div>
                    </form>
                </div>
            </div>
            <div class="row">
                <div class="col" style="padding-right: 50px;">
                    <div class="footer-widget">
                        <h4>Tentang Lab Kami</h4>
                        <div class="img">
                            <img src="../assets/images/LogoPolinema.png" alt="Logo Polinema" style="width: 80px;">
                            <img src="../assets/images/logoJTI.png" alt="Logo JTI" style="width: 70px;">
                            <img src="../assets/images/LogoLab2.png" alt="Logo Lab"
                                style="width: 110px; margin-left: -14px;">
                        </div>
                        <p>Laboratorium Jurusan Teknologi Informasi yang berfokus pada riset dan solusi
                            teknologi
                            informasi untuk
                            mendukung dunia
                            bisnis dan akademis.</p>
                    </div>
                </div>
                <div class="col">
                    <div class="footer-widget">
                        <h4>Hubungi Kami</h4>
                        <p>Jl. Soekarno Hatta No.9, Jatimulyo, Kec. Lowokwaru, Kota Malang, Jawa Timur 65141</p>

                        <div class="social-links-footer">
                            <a href="https://www.instagram.com/jtipolinema/" target="_blank"
                                title="Kunjungi Instagram Lab">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="https://www.youtube.com/@jtipolinema367" target="_blank"
                                title="Tonton Video di YouTube Lab">
                                <i class="fab fa-youtube"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="col">
                    <div class="footer-widget">
                        <div class="map-container" style="margin-bottom: 20px; position: relative;">

                            <a href="https://maps.google.com/?cid=8691078281011477154&g_mp=Cidnb29nbGUubWFwcy5wbGFjZXMudjEuUGxhY2VzLlNlYXJjaFRleHQ"
                                target="_blank"
                                style="display: block; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;"
                                title="Buka Google Maps Politeknik Negeri Malang">
                            </a>

                            <iframe
                                src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3951.5026830854117!2d112.6161209!3d-7.946891200000002!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x2e78827687d272e7%3A0x789ce9a636cd3aa2!2sPoliteknik%20Negeri%20Malang!5e0!3m2!1sid!2sid!4v1765378894293!5m2!1sid!2sid"
                                width="100%" height="250"
                                style="border:0; border-radius: 8px; position: relative; z-index: 1;" allowfullscreen=""
                                loading="lazy" referrerpolicy="no-referrer-when-downgrade"
                                title="Peta Lokasi Politeknik Negeri Malang">
                            </iframe>
                        </div>
                    </div>
                </div>

                <div class="col-lg-12" style="margin-top: -50px; margin-bottom: -50px;">
                    <div class="copyright-text">
                        <p>Copyright Â© 2025 Business Analytics Laboratory. All Rights Reserved.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>


    <script src="../vendor/jquery/jquery.min.js"></script>
    <script src="../vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/owl-carousel.js"></script>
    <script src="../assets/js/animation.js"></script>
    <script src="../assets/js/imagesloaded.js"></script>
    <script src="../assets/js/templatemo-custom.js"></script>
    <script src="../assets/js/popup.js"></script>

    <script>
        // API URL
        const DETAIL_API_URL = '../../backend/api/contents/detail.php';
        const LIST_API_URL = '../../backend/api/contents/list_public.php';

        /**
         * Helper function: Mengoreksi path gambar lokal yang tersimpan salah.
         * Jika path adalah '../../assets/...' (dari database), 
         * fungsi ini mengoreksinya menjadi '../assets/...' (yang dibutuhkan browser).
         */
        function getCorrectImagePath(path) {
            if (path && !path.startsWith('http') && path.startsWith('../../')) {
                // Hapus satu lapisan '../' hanya untuk path lokal yang disimpan dengan path PHP
                return path.replace('../../', '../');
            }
            // Kembalikan path asli jika itu URL (http/https) atau path yang sudah benar
            return path;
        }


        /**
         * Mengambil parameter 'slug' dari URL.
         */
        function getUrlSlug() {
            const params = new URLSearchParams(window.location.search);
            return params.get('slug');
        }

        /**
         * Merender konten utama berita ke dalam elemen HTML.
         */
        function renderBeritaDetail(data) {
            const container = document.getElementById('mainContent');
            const detailUrl = `detail_berita.html?slug=${data.slug || data.id}`;

            // --- APLIKASI KOREKSI PATH DI SINI ---
            const rawImageUrl = data.featured_image;
            const imageUrl = getCorrectImagePath(rawImageUrl) || '../assets/images/placeholder-berita.jpg';
            // -------------------------------------

            const kategoriNama = data.category_name || 'Umum';
            const tanggal = new Date(data.created_at).toLocaleDateString('id-ID', {
                year: 'numeric', month: 'long', day: 'numeric'
            });
            const author = data.author_name || 'Admin Lab';

            // 1. Update Header Halaman (Banner)
            document.getElementById('pageHeadingTitle').textContent = data.title;
            document.getElementById('breadcrumbTitle').textContent = data.title;

            // 2. Update Meta Tags (SEO)
            document.title = `${data.title} | Detail Berita`;
            document.querySelector('meta[name="description"]').setAttribute('content', data.excerpt || data.title);


            // 3. Render Konten Utama
            const htmlContent = `
            <div class="berita-header">
                <h1>${data.title}</h1>
                <div class="meta-info">
                    <span><i class="fa fa-user"></i> ${author}</span>
                    <span><i class="fa fa-calendar-alt"></i> ${tanggal}</span>
                    <span><i class="fa fa-tag"></i> ${kategoriNama}</span>
                </div>
            </div>

            ${imageUrl ? `<div class="featured-image-wrapper">
                <img src="${imageUrl}" alt="Gambar Unggulan ${data.title}">
            </div>` : ''}

            <div class="berita-body">
                ${data.body}
            </div>
        `;
            container.innerHTML = htmlContent;
        }

        /**
         * Mengambil detail berita dari API menggunakan slug.
         */
        const fetchBeritaDetail = async (slug) => {
            const container = document.getElementById('mainContent');
            const loadingElement = document.getElementById('contentLoading');

            try {
                const response = await fetch(`${DETAIL_API_URL}?slug=${slug}`);

                if (!response.ok) {
                    throw new Error(`Gagal mengambil data dari API: Status ${response.status}`);
                }

                const result = await response.json();

                if (result && result.status === 'success' && result.data) {
                    renderBeritaDetail(result.data);
                } else {
                    // API merespon 404/error atau data kosong
                    throw new Error(result.message || 'Berita tidak ditemukan.');
                }

            } catch (error) {
                console.error('Error fetching Berita detail:', error);

                // Ganti loading dengan pesan error
                document.getElementById('pageHeadingTitle').textContent = 'Error 404';
                document.getElementById('breadcrumbTitle').textContent = 'Tidak Ditemukan';
                container.className = 'berita-detail-content'; // Reset class
                container.innerHTML = `
                <div class="error-message" style="text-align: center; padding: 50px;">
                    <h2 style="color: red;">Konten Tidak Ditemukan</h2>
                    <p>Berita dengan URL ini tidak ada atau telah dihapus. (${error.message})</p>
                    <a href="daftar-berita.html" class="main-button-secondary">Kembali ke Daftar Berita</a>
                </div>
            `;
            }
        };


        /**
         * Merender daftar berita terbaru di sidebar.
         */
        const fetchRecentPosts = async () => {
            const container = document.getElementById('recentPostsContainer');

            try {
                // Ambil semua data publik, tapi hanya 5 teratas
                const response = await fetch(LIST_API_URL);
                if (!response.ok) throw new Error('Gagal mengambil daftar berita publik.');

                const result = await response.json();

                if (result && result.status === 'success' && Array.isArray(result.data)) {
                    // Ambil 4 berita terbaru (selain yang sedang dibuka)
                    const currentSlug = getUrlSlug();
                    const recentData = result.data
                        .filter(item => item.slug !== currentSlug) // Filter berita yang sedang aktif
                        .slice(0, 4); // Ambil 4 item pertama

                    if (recentData.length === 0) {
                        container.innerHTML = `<p class="loading-message" style="padding: 0;">Tidak ada berita terbaru.</p>`;
                        return;
                    }

                    let html = '';
                    recentData.forEach(item => {
                        const tanggal = new Date(item.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                        const detailUrl = `detail_berita.html?slug=${item.slug || item.id}`;

                        // --- APLIKASI KOREKSI PATH DI SINI ---
                        const imageUrl = getCorrectImagePath(item.featured_image) || '../assets/images/placeholder-thumb.jpg';
                        // -------------------------------------

                        html += `
                        <div class="recent-post-item">
                            <a href="${detailUrl}" class="post-thumb">
                                <img src="${imageUrl}" alt="${item.title}">
                            </a>
                            <div class="post-info">
                                <a href="${detailUrl}">${item.title}</a>
                                <span class="post-meta"><i class="fa fa-calendar-alt"></i> ${tanggal}</span>
                            </div>
                        </div>
                    `;
                    });
                    container.innerHTML = html;
                } else {
                    throw new Error('Data recent posts tidak valid.');
                }

            } catch (error) {
                console.error('Error fetching Recent Posts:', error);
                container.innerHTML = `<p class="error-message" style="color: red; padding: 0;">Gagal memuat berita terbaru.</p>`;
            }
        };


        // --- Eksekusi Utama ---
        window.addEventListener('load', () => {
            const slug = getUrlSlug();

            if (slug) {
                // 1. Ambil dan render detail konten
                fetchBeritaDetail(slug);
            } else {
                // Jika tidak ada slug di URL, tampilkan pesan error
                const container = document.getElementById('mainContent');
                document.getElementById('pageHeadingTitle').textContent = 'Error';
                document.getElementById('breadcrumbTitle').textContent = 'Invalid URL';
                container.className = 'berita-detail-content';
                container.innerHTML = `
                <div class="error-message" style="text-align: center; padding: 50px;">
                    <h2 style="color: orange;">Parameter URL Hilang</h2>
                    <p>URL tidak valid. Pastikan Anda mengakses dari <a href="daftar-berita.html">daftar berita</a>.</p>
                </div>
            `;
            }

            // 2. Muat Berita Terbaru di Sidebar (Selalu jalankan)
            fetchRecentPosts();
        });
    </script>
</body>

</html>